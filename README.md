# ups_mqtt

`ups_mqtt` ist ein kleines Python-Skript, das die Statusinformationen einer **an eine Synology NAS angeschlossenen USV** (z.‚ÄØB. √ºber USB) abfragt und √ºber **MQTT** an ein Smart-Home-System wie **Home Assistant** √ºbertr√§gt.

Das Skript l√§uft in einem **Docker-Container** direkt auf der Synology (oder einem anderen Docker-f√§higen Ger√§t) und sendet regelm√§√üig die Daten der USV √ºber das MQTT-Protokoll.

---

## üß© Voraussetzungen

- Eine Synology NAS mit:
  - Docker installiert
  - Einer √ºber USB angeschlossenen und unterst√ºtzten USV
  - Dem aktivierten **UPS-Server** (`Systemsteuerung > Hardware & Energie > USV`)
- Ein MQTT-Broker im Netzwerk (z.‚ÄØB. Mosquitto)
- Optional: Home Assistant zur Anzeige der Werte

---

## üõ†Ô∏è Einrichtung (zum "Selberbauen")

Auf einem Ger√§t mit Docker (z.‚ÄØB. Synology NAS oder Debian/Ubuntu Server) folgende Schritte ausf√ºhren:

### üìÅ Projektstruktur erstellen
Wer nano nicht installiert hat, kann auch vi oder den Editor seiner Wahl nutzen.
Installation von nano auf einer Synology: https://think.unblog.ch/nano-auf-synology-nas-installieren/

Den Inhalt f√ºr die 3 Dateien die ihr gleich erstellt, findet ihr hier im Repository.

```bash
sudo mkdir ups_mqtt
cd ups_mqtt

sudo nano ups_mqtt.py         # Python-Skript (siehe Code im Repository)
sudo nano Dockerfile          # Dockerfile zum Erstellen des Containers
sudo nano requirements.txt    # Python-Abh√§ngigkeiten
```

### üê≥ Docker-Image bauen

```bash
sudo docker build -t ups_mqtt .
```

Optional: F√ºr sp√§tere Wiederverwendung exportieren:

```bash
sudo docker save -o ups_mqtt_image.tar ups_mqtt
```

---

## ‚öôÔ∏è Konfigurierbare Umgebungsvariablen

| Variable              | Beschreibung                                                                 | Standardwert              |
|-----------------------|------------------------------------------------------------------------------|---------------------------|
| `MQTT_BROKER`         | IP-Adresse oder Hostname des MQTT-Brokers                                    | `192.168.178.27`          |
| `MQTT_PORT`           | Port des MQTT-Brokers                                                        | `1883`                    |
| `MQTT_USER`           | *(Optional)* Benutzername f√ºr den MQTT-Broker                                | *(leer)*                  |
| `MQTT_PASSWORD`       | *(Optional)* Passwort f√ºr den MQTT-Broker                                    | *(leer)*                  |
| `MQTT_TOPIC_BASE`     | Basis-Topic f√ºr MQTT-Nachrichten                                             | `home/ups`                |
| `UPS_NAME`            | UPS-Name (muss mit dem Namen im UPS-Server √ºbereinstimmen)                   | `ups`                     |
| `UPS_HOST`            | Hostname/IP des UPS-Servers                                                  | `localhost`               |
| `POLL_INTERVAL`       | Abfrageintervall f√ºr wichtige Variablen (in Sekunden)                        | `1`                       |
| `FULL_UPDATE_INTERVAL`| Intervall f√ºr das Senden **aller** Variablen (in Sekunden)                   | `30`                      |
| `IMPORTANT_VARS`      | Kommagetrennte Liste wichtiger Variablen, die h√§ufiger gesendet werden sollen| `battery.runtime,ups.status` |

---

## ‚ñ∂Ô∏è Container starten (√ºber die Synology GUI)


## ‚ñ∂Ô∏è Container starten (von der Shell)

```bash
sudo docker run -d \
  --name ups_mqtt \
  --restart unless-stopped \
  -e MQTT_BROKER=192.168.178.27 \
  -e MQTT_PORT=1884 \
  -e MQTT_USER=benutzername \
  -e MQTT_PASSWORD=passwort \
  -e UPS_NAME=ups \
  -e UPS_HOST=localhost \
  -e MQTT_TOPIC_BASE=home/ups \
  -e POLL_INTERVAL=2 \
  -e FULL_UPDATE_INTERVAL=30 \
  -e IMPORTANT_VARS="battery.runtime,ups.status" \
  ups_mqtt
```

---

## üè° Home Assistant MQTT Discovery

Beim ersten Start sendet das Skript automatisch MQTT Discovery-Payloads f√ºr Home Assistant an Topics wie:

```
homeassistant/sensor/ups_battery_runtime/config
homeassistant/sensor/ups_ups_status/config
```

Damit Home Assistant die Sensoren korrekt erkennt, muss MQTT Discovery aktiviert sein.

Die Sensordaten werden regelm√§√üig an Topics unterhalb von `MQTT_TOPIC_BASE` gesendet, z.‚ÄØB.:

```
home/ups/battery.runtime
home/ups/ups.status
```

---

